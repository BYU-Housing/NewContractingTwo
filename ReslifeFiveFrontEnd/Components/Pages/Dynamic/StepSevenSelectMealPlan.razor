@page "/stepSevenSelectMealPlan"
@inject NavigationManager NavigationManager
@inject IGenService GenService

<h3>Step Seven: Select Meal Plan</h3>

<div class="row">
    <!-- Left-side: Buttons -->
    <div class="col-md-3">
        <div class="button-container">
            @foreach (var plan in MealPlans)
            {
                <button class="btn @(SelectedMealPlan == plan ? "btn-success" : "btn-primary") mb-2 w-100"
                        @onclick="() => SelectMealPlan(plan)">
                    @plan
                </button>
            }
        </div>
    </div>

    <div class="col-md-9">
        <div class="content-container">
            @if (SelectedMealPlan != null)
            {
                <div>
                    @MealPlanDescriptions[SelectedMealPlan]
                </div>

                <div class="mt-3">
                    <h5>Do you have any dietary restrictions?</h5>
                    <div>
                        <input type="radio" id="yes" name="dietaryRestrictions" value="yes" checked="@(HasDietaryRestrictions == true)" @onchange="() => HandleDietaryRestrictionsChange(true)" />
                        <label for="yes">Yes</label>
                    </div>
                    <div>
                        <input type="radio" id="no" name="dietaryRestrictions" value="no" checked="@(HasDietaryRestrictions == false)" @onchange="() => HandleDietaryRestrictionsChange(false)" />
                        <label for="no">No</label>
                    </div>
                </div>

                @if (HasDietaryRestrictions == true)
                {
                    <div class="mt-3">
                        <h5>Please provide a description of your dietary restrictions:</h5>
                        <textarea class="form-control" @bind="DietaryRestrictionDescription" rows="3" @oninput="HandleDietaryRestrictionInput"></textarea>
                    </div>
                }

                @if (HasDietaryRestrictions == false || !string.IsNullOrWhiteSpace(DietaryRestrictionDescription))
                {
                    <div class="mt-3">
                        <button class="btn btn-primary" @onclick="ProceedToSignAgreement">Proceed to Sign Agreement</button>
                    </div>
                }
            }
            else
            {
                <p>Please select a meal plan to see details.</p>
            }
        </div>
    </div>

</div>

@code {
    private List<string> MealPlans = new List<string>
    {
        "19 + ",
        "Dining Plus",
        "EZ Dining 100",
        "EZ Dining 150",
        "EZ Dining 200",
        "Open Door",
        "True Blue Dining 500",
        "True Blue Dining 500 Weekly",
        "True Blue Dining 800",
        "True Blue Dining 800 Weekly",
        "No Meal Plan"
    };

    private Dictionary<string, MarkupString> MealPlanDescriptions = new Dictionary<string, MarkupString>
{
    { "19 + ", (MarkupString)@"<div  style=""width: 100%; max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 15px;"">
    <p>Plan Description</p>
    <p>
        With the 19+ meal plan, plan holders receive a $1650 Dining Dollar allotment per semester/term.
        The 19+ meal plan is only available to residents of Helaman Halls who turn 19 prior to January 1, 2024.
    </p>

    <p>Plan Details:</p>
    <ul>
        <li>Cost:</li>
        <ul>
            <li>Fall-Winter Semesters - $3260.00 (Fall Semester - $1630.00, Winter Semester - $1630.00)</li>
        </ul>
        <li>Meal Charges at The Commons:</li>
        <ul>
            <li>Discount: 20% off door rate</li>
            <li><em>*Rates are subject to change*</em></li>
        </ul>
        <li>This meal plan is available only to residents of Helaman Halls who had their 19th birthday prior to January 1st, 2024.</li>
        <li>Dining Dollars may be used at Dining Services locations, excluding Concessions and Campus Floral.</li>
        <li>
            Holders are exempt from delivery fees associated with orders placed with CougarDash and Meals To-go
            when placing orders using dining dollars.
        </li>
        <li>Dining Dollars are accessible during the Christmas break for those with Fall-Winter agreements.</li>
        <li>
            The Cannon Commons does not maintain regular hours during the break and may close during a portion of the break.
        </li>
        <li>Plan holders receive the full semester allotment on the first day of the agreement.</li>
        <li>
            Additional blocks of 55 Dining Dollars may be added for $50. These blocks can be added via My Dining Account
            but must be paid for in My Financial Center.
        </li>
        <li>
            Until the add/drop deadline for classes each semester, any requests for meal plan changes or cancellations from
            students will be automatically approved, excluding Helaman Halls residents who may switch between Helaman Halls
            approved meal plan options but not cancel.
        </li>
        <li>
            For changes or cancellations after the add/drop deadline, students must submit petitions which are subject to review.
        </li>
        <li>
            If a meal plan holder fails to enroll in a new meal plan at the end of the current agreement period,
            and does not meet the exceptions above, any unused Dining Dollars will be forfeited at 11:59 p.m. on
            the last day of the agreement period.
        </li>
        <li>
            If a plan holder who does not meet the above exemptions purchases a new contract after their previous
            agreement period has terminated, they will be eligible to access their previously forfeited Dining Dollars.
        </li>
        <li>
            A plan holder living on campus may be released from their meal plan only if released from their on-campus housing agreement.
        </li>
        <li>
            If released from their on-campus housing agreement, the meal plan charge will be pro-rated based upon the last day of the housing agreement.
        </li>
        <li>
            If a meal plan holder uses more than the pro-rated amount, then they will be charged for the amount used.
        </li>
        <li>
            If, during a semester/term, a student moves from Helaman Halls and cancels/changes the meal plan,
            any charge(s) and credit(s) will be pro-rated based upon the move date.
        </li>
        <li>
            Meal plan holders may petition to discontinue/change their meal plan at any time. Petitions are subject to review by
            the Meal Plan Review Board on an individual basis. It is understood that if their petition to discontinue is granted,
            the meal plan holder will forfeit:
        </li>
        <ul>
            <li>Any accumulated Dining Dollar rollover from previous semesters.</li>
            <li>Any current Dining Dollar accrual from the current agreement period.</li>
        </ul>
        <li>
            Additionally, if the meal plan holder is released from the meal plan agreement, the meal plan charge will
            be pro-rated based upon the length of time remaining in the agreement.
        </li>
        <li>
            If a plan holder is released from the meal plan during the agreement period, any unused Dining Dollars
            will be forfeited at 11:59 p.m. on the release date.
        </li>
        <li>
            If the plan holder begins or is released from their agreement on any day except those listed as official
            start and end dates, all charges and Dining Dollar allotment will be prorated.
        </li>
    </ul>

    <p>The Cannon Commons will be closed the following dates:</p>
    <ul>
        <li>After Dinner Nov 27, 2024 – Before Dinner Nov 30, 2024</li>
        <li>After Breakfast Dec 19, 2024 – Before Lunch Jan 6, 2025</li>
        <li>After Breakfast Aug 15, 2025 – Before Dinner Aug 16, 2025</li>
    </ul>
</div>
" },
    { "Dining Plus",  (MarkupString)@"<div  style=""width: 100%; max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 15px;"">
    <p>Plan Description</p>
    <p>
        The Dining Plus meal plan provides a daily allocation of $15.00 Dining Dollars (except during Christmas break) which
        plan holders may use to purchase goods and services for themselves and for their guests.
    </p>

    <p>Plan Details:</p>
    <ul>
        <li>Cost:</li>
        <ul>
            <li>Fall-Winter Semesters - $5290 (Fall Semester - $2645, Winter Semester - $2645)</li>
            <li>Spring Term - $1322.50</li>
            <li>Summer Term - $1322.50</li>
        </ul>
        <li>Cannon Commons Meal Charges:</li>
        <ul>
            <li>Monday through Saturday: Breakfast – $5.00, Lunch – $5.00, Dinner – $5.00</li>
            <li>Sunday: Continental Breakfast – $5.00, Dinner – $10.00</li>
        </ul>
        <li><em>*Rates are subject to change*</em></li>
        <li>This meal plan is available to all students.</li>
        <li>Dining Plus may be used at all Dining Services locations, excluding Concessions and Campus Floral.</li>
        <li>
            Holders are exempt from delivery fees associated with orders placed with CougarDash and Meals To-go
            when placing orders using dining dollars.
        </li>
        <li>Plan holders receive the $15.00 allotment each day at 12:01 AM.</li>
        <li>
            Dining Dollar balance is accessible during the Christmas break for those with Fall-Winter agreements.
            The $15.00 daily allotment does not occur over Christmas break. The Cannon Commons does not maintain
            regular hours during the break and may close during a portion of the break.
        </li>
        <li>
            Additional blocks of 55 Dining Dollars may be added for $50. These blocks can be added via My Dining Account
            but must be paid for in My Financial Center.
        </li>
        <li>Any unused portion of the daily allotment will carry over to the next day.</li>
        <li>
            Dining Dollars at the end of Fall semester will roll over to the Dining Dollars portion of the student’s Winter semester meal
            plan with an accrual limit of $200 if they are contracted with a rollover qualified plan for Winter semester.
        </li>
        <li>
            Dining Dollars remaining at the end of the agreement period or when granted a change in meal plans, up to $200,
            will be added to the Dining Dollars portion of a new plan, (with the exception of the EZ Dining plan) if the student
            enrolls in a rollover qualified meal plan. Rollover from meal plans may apply until the student’s graduation from BYU.
        </li>
        <li>
            Plans purchased for semesters and terms PRIOR to Fall 2024 are exempt from rollover accrual limits, holders may roll
            the full amount of funds from these plans into any rollover qualified plan. After rollover into a new plan, any further
            rollover is limited to the $200 accrual limit for future plans.
        </li>
        <li>
            If a meal plan holder fails to enroll in a new meal plan, any unused Dining Dollars will be forfeited at 11:59 p.m. on
            the last day of the agreement period.
        </li>
        <li>
            A plan holder living on campus may be released from their meal plan only if released from their on-campus housing agreement.
            If released from their on-campus housing agreement, the meal plan charge will be pro-rated based upon the last day of the
            housing agreement.
        </li>
        <li>
            A plan holder living off campus may be released from their meal plan only upon discontinuance/graduation from the university.
            If released, the meal plan charge will be pro-rated based upon the discontinuance/graduation date.
        </li>
        <li>
            Until the add/drop deadline for classes each semester, any requests for meal plan changes or cancellations from students will
            be automatically approved, excluding Helaman Halls residents who may switch between Helaman Halls approved meal plan options
            but not cancel.
        </li>
        <li>
            For changes or cancellations after the add/drop deadline, students must submit petitions which are subject to review.
        </li>
        <li>
            Meal plan holders may petition to discontinue/change their meal plan at any time. Petitions are subject to review by the Meal
            Plan Review Board on an individual basis. It is understood that if their petition to discontinue is granted, the meal plan holder
            will forfeit:
        </li>
        <ul>
            <li>Any accumulated Dining Dollar rollover from previous semesters.</li>
            <li>Any current Dining Dollar accrual from the current agreement period.</li>
        </ul>
        <li>
            Additionally, if the meal plan holder is released from the meal plan agreement, the meal plan charge will be pro-rated based
            upon the length of time remaining in the agreement.
        </li>
        <li>
            If a plan holder is released from the meal plan during the agreement period, any unused Dining Dollars will be forfeited at
            11:59 p.m. on the release date.
        </li>
        <li>
            If the plan holder begins or is released from their agreement on any day except those listed as official start and end dates,
            all charges and Dining Dollar allotments will be prorated.
        </li>
    </ul>

    <p>The Cannon Commons will be closed on the following dates:</p>
    <ul>
        <li>After Dinner Nov 27, 2024 – Before Dinner Nov 30, 2024</li>
        <li>After Breakfast Dec 19, 2024 – Before Lunch Jan 6, 2025</li>
        <li>After Breakfast Aug 15, 2025 – Before Dinner Aug 16, 2025</li>
    </ul>
</div>
" },
    { "EZ Dining 100", (MarkupString)@"<p>The <strong>EZ Dining 100</strong> plan includes <strong>100 dining dollars</strong> for use across campus.</p>" },
    { "EZ Dining 150", (MarkupString)@"<p>The <strong>EZ Dining 150</strong> plan includes <strong>150 dining dollars</strong> for use across campus.</p>" },
    { "EZ Dining 200", (MarkupString)@"<p>The <strong>EZ Dining 200</strong> plan includes <strong>200 dining dollars</strong> for use across campus.</p>" },
    { "Open Door", (MarkupString)@"<p><strong>Open Door</strong> offers access to dining halls with <em>pay-per-meal</em> options.</p>" },
    { "True Blue Dining 500", (MarkupString)@"<p><strong>True Blue Dining 500</strong> provides <strong>500 meals per semester</strong> with access to premium options.</p>" },
    { "True Blue Dining 500 Weekly", (MarkupString)@"<p><strong>True Blue Dining 500 Weekly</strong> offers <strong>500 meals per semester</strong>, distributed weekly.</p>" },
    { "True Blue Dining 800", (MarkupString)@"<p><strong>True Blue Dining 800</strong> provides <strong>800 meals per semester</strong> with access to all dining facilities.</p>" },
    { "True Blue Dining 800 Weekly", (MarkupString)@"<p><strong>True Blue Dining 800 Weekly</strong> offers <strong>800 meals per semester</strong>, distributed weekly.</p>" },
    { "No Meal Plan", (MarkupString)@"<p><strong>No Meal Plan</strong> allows students to <em>opt out</em> of on-campus dining options.</p>" }
};

    private string? SelectedMealPlan;
    private int? SelectedMealPlanIndex;
    private bool? HasDietaryRestrictions;
    private string DietaryRestrictionDescription = string.Empty;
    private Dictionary<string, string> UrlParameters = new();

    protected override void OnInitialized()
    {
        // Parse the current URL to extract existing parameters
        var uri = new Uri(NavigationManager.Uri);
        UrlParameters = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query)
            .ToDictionary(k => k.Key, v => v.Value.ToString());
    }

    private void SelectMealPlan(string plan)
    {
        SelectedMealPlan = plan;
        SelectedMealPlanIndex = MealPlans.IndexOf(plan) + 1; // 1-based index
        ResetDietaryRestrictions();
        StateHasChanged();
    }

    private void HandleDietaryRestrictionsChange(bool hasRestrictions)
    {
        HasDietaryRestrictions = hasRestrictions;

        if (!hasRestrictions)
        {
            DietaryRestrictionDescription = string.Empty;
        }
    }

    private void ResetDietaryRestrictions()
    {
        HasDietaryRestrictions = null;
        DietaryRestrictionDescription = string.Empty;
    }

    private void HandleDietaryRestrictionInput(ChangeEventArgs e)
    {
        DietaryRestrictionDescription = e.Value?.ToString() ?? string.Empty;
    }

    private void ProceedToSignAgreement()
    {
        // Add new parameters
        UrlParameters["SelectedMealPlan"] = SelectedMealPlanIndex?.ToString() ?? "0";
        UrlParameters["HasDietaryRestrictions"] = HasDietaryRestrictions?.ToString()?.ToLower() ?? "false";

        // Construct new query string
        var queryString = string.Join("&", UrlParameters.Select(kvp => $"{kvp.Key}={Uri.EscapeDataString(kvp.Value)}"));

        // Navigate to the next page with updated parameters
        NavigationManager.NavigateTo($"/stepEightSignHousingAgreement?{queryString}");
    }
}

